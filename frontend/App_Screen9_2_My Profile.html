<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection Failed</title>
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100%;
            min-height: 100vh;
            overflow-x: hidden;
        }

        img {
            max-width: 100%;
            height: auto;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            input, button {
                font-size: 16px !important;
            }
        }
        

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100%;
            min-height: 100vh;
            overflow-x: hidden;
        }

        img {
            max-width: 100%;
            height: auto;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            input, button {
                font-size: 16px !important;
            }
        }
        

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100%;
            min-height: 100vh;
            overflow-x: hidden;
        }

        img {
            max-width: 100%;
            height: auto;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            input, button {
                font-size: 16px !important;
            }
        }
        
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: #f5f9fb;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            position: fixed;
            top: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #2A9D8F;
        }

        /* Error Container */
        .error-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            text-align: center;
            max-width: 500px;
            width: 90%;
            margin-top: 80px; /* Offset for fixed header */
            margin-bottom: 80px; /* Offset for bottom navigation */
        }

        /* Error Icon Animation */
        .error-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 30px;
            animation: shake 0.8s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-5px); }
        }

        /* Troubleshooting Guide */
        .troubleshooting-list {
            text-align: left;
            margin: 2rem 0;
            padding: 1.5rem;
            background: #fff5f5;
            border-radius: 12px;
            border: 1px solid #ffd6d6;
        }

        .troubleshooting-list ul {
            list-style-type: none; /* Remove bullet points */
            padding: 0;
            margin: 0;
        }

        .troubleshooting-list li {
            margin: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .troubleshooting-list li::before {
            content: "‚úÖ"; /* Use checkmark emoji */
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-retry {
            background: #ff4444;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        /* Error Code Styling */
        .error-code {
            color: #ff4444;
            font-family: monospace;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 1rem 0;
            border-top: 1px solid #eee;
        }

        .nav-item {
            text-align: center;
            color: #888;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .nav-item.active {
            color: #2A9D8F;
        }

        /* Bottom Navigation Icons */
        .bottom-nav .nav-item {
            color: #808080;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s ease;
            text-align: center;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Health Data Icon specific style */
        .health-data-icon {
            width: 24px;
            height: 24px;
            display: inline-block;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FF0000' d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .nav-item.active .health-data-icon {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }
    </style>
</head>
<body>
    <!-- Header with back button -->
    <header class="header">
        <div class="header-left">
            <button class="back-button" onclick="window.location.href='App_Screen8_My Profile.html'">‚Üê</button>
            <h2>Connect New Device</h2>
        </div>
    </header>

    <!-- Error Container -->
    <div class="error-container">
        <!-- Animated Error Icon -->
        <div class="error-icon">
            <svg viewBox="0 0 24 24" fill="#ff4444" width="100" height="100">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
        </div>

        <h1>Connection Failed</h1>
        <p class="error-code">Error: BLT-404 | Device Not Found</p>

        <!-- Troubleshooting Steps -->
        <div class="troubleshooting-list">
            <h3>Troubleshooting Steps:</h3>
            <ul>
                <li>Ensure Bluetooth is enabled on both devices</li>
                <li>Keep devices within 3 feet (1 meter)</li>
                <li>Restart device and enter pairing mode</li>
                <li>Check device battery level</li>
            </ul>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-retry" onclick="handleRetry()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
                Retry Connection
            </button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-item" onclick="window.location.href='APP_Screen2_User Dashboard(Home Page).html'">üè†</div>
        <div class="nav-item" onclick="window.location.href='App_Screen3_1_Appointment.html'">üìÖ</div>
        <div class="nav-item" onclick="window.location.href='App_Screen4_1_Health Data.html'">
            <div class="health-data-icon"></div>
        </div>
        <div class="nav-item" onclick="window.location.href='App_Screen5_Insights.html'">üìä</div>
        <div class="nav-item" onclick="window.location.href='App_Screen6_My Profiles.html'">üë§</div>
    </nav>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000/api';
        let deviceId = null;
        let retryCount = 0;
        const MAX_RETRIES = 3;

        // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñËÆæÂ§áID
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            deviceId = urlParams.get('deviceId');
            
            if (!deviceId) {
                showAlert('Device ID not found', 'error');
            }
        });

        async function handleRetry() {
            const btn = document.querySelector('.btn-retry');
            const originalHTML = btn.innerHTML;
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            btn.innerHTML = `
                <div class="loader"></div>
                Connecting...
            `;
            btn.disabled = true;

            try {
                // Ë∞ÉÁî®APIÈáçËØïËøûÊé•
                const response = await fetch(`${API_BASE_URL}/devices/${deviceId}/connect`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Connection failed');
                }

                const result = await response.json();
                
                if (result.success) {
                    // ËøûÊé•ÊàêÂäüÔºåÈáçÂÆöÂêëÂà∞ÊàêÂäüÈ°µÈù¢
                    window.location.href = `App_Screen9_1_My Profile.html?deviceId=${deviceId}`;
                } else {
                    // ËøûÊé•Â§±Ë¥•ÔºåÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                    retryCount++;
                    if (retryCount >= MAX_RETRIES) {
                        showAlert('Maximum retry attempts reached. Please check device settings.', 'error');
                    } else {
                        showAlert(`Connection failed. Retry attempt ${retryCount}/${MAX_RETRIES}`, 'error');
                    }
                    
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Error during connection retry:', error);
                showAlert('Connection failed. Please check device settings.', 'error');
                
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // ÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
        function showAlert(message, type = 'info') {
            // ÂàõÂª∫ÊèêÁ§∫ÂÖÉÁ¥†
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
            
            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(alertDiv);
            
            // 3ÁßíÂêéÁßªÈô§
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Ê∑ªÂä†ÊèêÁ§∫Ê†∑Âºè
        const style = document.createElement('style');
        style.textContent = `
            .alert {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                border-radius: 5px;
                color: white;
                z-index: 1000;
                animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
            }
            
            .alert.success {
                background-color: #10b981;
            }
            
            .alert.error {
                background-color: #ef4444;
            }
            
            .alert.info {
                background-color: #3b82f6;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(-20px); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>